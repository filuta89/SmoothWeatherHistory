{% extends 'base.html.twig' %}

{% block head %}
    {% block stylesheets %}
        {{ parent() }}
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    {% endblock %}
    {% block title %}Smooth Weather History{% endblock %}
{% endblock %}

{% block body %}

    <h1>Smooth Weather History</h1>

    {{ form_start(form) }}
        {{ form_label(form.startDate) }}
        {{ form_widget(form.startDate) }}

        {{ form_label(form.endDate) }}
        {{ form_widget(form.endDate) }}

        {{ form_label(form.city) }}
        {{ form_widget(form.city, {'id': 'city'}) }}

        {{ form_label(form.latitude) }}
        {{ form_widget(form.latitude, {'id': 'latitude'}) }}

        {{ form_label(form.longitude) }}
        {{ form_widget(form.longitude, {'id': 'longitude'}) }}

        <button type="submit" class="btn btn-primary">Submit</button>
    {{ form_end(form) }}

    <div id="accordion">
        {% for response_id in response_ids %}
            {% set weather_data_instance = weather_data[loop.index0] %}
            {% include 'weather_data.html.twig' with {'weather_data': weather_data_instance, 'index': loop.index, 'response_id': response_id} %}
            <script>
                console.log("Response ID: {{ response_id }}");
            </script>
        {% endfor %}
    </div>

    {% block javascripts %}
        {{ parent() }}
        <script src="{{ asset('js/autocomplete.js') }}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const initDatepicker = (elementId) => {
                    $(elementId).datepicker({
                        dateFormat: "dd/mm/yy",
                        minDate: new Date(1941, 0, 1),
                        maxDate: "-6d",
                    });
                };

                initDatepicker("#{{ form.startDate.vars.id }}");
                initDatepicker("#{{ form.endDate.vars.id }}");

                const deleteButtons = document.querySelectorAll('.delete-weather-btn');

                deleteButtons.forEach(function (button) {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();

                        if (confirm('Are you sure you want to delete this weather data?')) {
                            const responseId = event.target.getAttribute('data-response-id');
                            fetch('{{ path('delete_weather_data') }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: new URLSearchParams({
                                    'response_id': responseId
                                })
                            }).then(function (response) {
                                if (response.status === 204) {
                                    const card = event.target.closest('.card');
                                    card.remove();
                                } else {
                                    alert('An error occurred while deleting the weather data.');
                                }
                            }).catch(function (error) {
                                console.error('Error:', error);
                                alert('An error occurred while deleting the weather data.');
                            });
                        }
                    });
                });
            });
        </script>
    {% endblock %}
{% endblock %}
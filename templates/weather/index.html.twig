{% extends 'base.html.twig' %}

{% block head %}
    {% block stylesheets %}
        {{ parent() }}
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    {% endblock %}
    {% block title %}Hello WeatherController!{% endblock %}
{% endblock %}

{% block body %}
    <style>
        .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
        .example-wrapper code { background: #A5A5A5; padding: 2px 6px; }
    </style>

    <h1>Fetch Weather Data</h1>

    {{ form_start(form) }}
        {{ form_label(form.startDate) }}
        {{ form_widget(form.startDate) }}

        {{ form_label(form.endDate) }}
        {{ form_widget(form.endDate) }}

        {{ form_label(form.city) }}
        {{ form_widget(form.city, {'id': 'city'}) }}

        {{ form_label(form.latitude) }}
        {{ form_widget(form.latitude, {'id': 'latitude'}) }}

        {{ form_label(form.longitude) }}
        {{ form_widget(form.longitude, {'id': 'longitude'}) }}

        <button type="submit" class="btn btn-primary">Submit</button>
    {{ form_end(form) }}

    <div id="accordion">
        {% include 'weather_data.html.twig' with {'weather_data': weather_data} %}
    </div>

    {% block javascripts %}
        {{ parent() }}
        <script src="{{ asset('js/autocomplete.js') }}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                $("#{{ form.startDate.vars.id }}").datepicker({
                    dateFormat: "dd/mm/yy",
                    maxDate: "-6d"
                });

                $("#{{ form.endDate.vars.id }}").datepicker({
                    dateFormat: "dd/mm/yy",
                    maxDate: "-6d"
                });

                const deleteButtons = document.querySelectorAll('.delete-weather-btn');

                deleteButtons.forEach(function (button) {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();

                        if (confirm('Are you sure you want to delete this weather data?')) {
                            const responseId = event.target.getAttribute('response-id');
                            fetch('{{ path('delete_weather_data') }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: new URLSearchParams({
                                    'response_id': responseId
                                })
                            }).then(function (response) {
                                if (response.status === 204) {
                                    const card = event.target.closest('.card');
                                    card.remove();
                                } else {
                                    alert('An error occurred while deleting the weather data.');
                                }
                            }).catch(function (error) {
                                console.error('Error:', error);
                                alert('An error occurred while deleting the weather data.');
                            });
                        }
                    });
                });
            });
        </script>
    {% endblock %}
{% endblock %}
